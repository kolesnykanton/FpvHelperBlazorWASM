@using System.Globalization
@using FpvHelperBlazorWASM.Models

@inject IJSRuntime JS

@if (Forecast is null)
{
    <p>⏳ Прогноз завантажується…</p>
}
else
{
    <div class="forecast-cards d-flex justify-content-between">
        @foreach (var point in Points)
        {
            <div class="card forecast-card text-center">
                <div class="card-body p-2">
                    <!-- година -->
                    <div class="forecast-hour">
                        @point.DateTime.ToLocalTime().ToString("HH:mm", CultureInfo.InvariantCulture)
                    </div>

                    <!-- іконка погоди (сонце / хмари / дощ) -->
                    <div class="forecast-icon my-1">
                        @if (point.Precip >= 50)
                        {
                            <i class="bi bi-cloud-rain-fill text-primary"></i>
                        }
                        else if (point.Precip > 10)
                        {
                            <i class="bi bi-cloud-sun-rain-fill text-secondary"></i>
                        }
                        else
                        {
                            <i class="bi bi-sun-fill text-warning"></i>
                        }
                    </div>

                    <!-- температура -->
                    <div class="forecast-temp">
                        @Math.Round(point.Temp)°C
                    </div>

                    <!-- стрілка вітру, повернемо її CSS‑ротейтом -->
                    <div class="forecast-wind my-1">
                        <i class="bi bi-arrow-up wind-arrow"
                           style="transform:rotate(@point.WindDir deg)"></i>
                        <span class="small">@Math.Round(point.WindSpeed, 1)</span>
                    </div>

                    <!-- ймовірність опадів -->
                    <div class="forecast-precip small text-info">
                        @point.Precip%
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter] public PointForecastResponse? Forecast { get; set; }

    private record CardPoint(DateTimeOffset DateTime, double Temp, double WindSpeed, double WindDir, double Precip);

    private List<CardPoint> Points = new();

    protected override void OnParametersSet()
    {
        if (Forecast is null) return;

        // беремо значення на 1,3,6,12 годин попереду
        var now = Forecast.Ts[0];
        var targets = new[] { 1, 3, 6, 12 }
            .Select(h => now + h * 3600_000)
            .ToArray();

        Points = targets
            .Select(t =>
            {
                // знайдемо індекс найближчого часового штампа
                int idx = Array.FindIndex(Forecast.Ts, ts => ts >= t);
                if (idx < 0 || idx >= Forecast.Ts.Length) idx = Forecast.Ts.Length - 1;

                return new CardPoint(
                    DateTimeOffset.FromUnixTimeMilliseconds(Forecast.Ts[idx]),
                    Forecast.TempSurface[idx],
                    Forecast.WindSpeed[idx],
                    Forecast.WindDir[idx],
                    Forecast.PrecipSurface[idx]
                );
            })
            .ToList();
    }
}
